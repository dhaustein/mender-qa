
.template_release_board_artifacts:
  tags:
    - mender-qa-worker-generic-light
  # Jobs including this template must define PUBLISH_BOARD_NAME and set up dependencies
  stage: release
  image: debian:12
  before_script:
    # Install dependencies
    - apt update && apt install -yyq awscli git wget python3 python3-pip xz-utils
    - wget https://raw.githubusercontent.com/mendersoftware/integration/master/extra/requirements.txt
    - pip install --break-system-packages -r requirements.txt
    # Restore workspace from init stage
    - export WORKSPACE=$(realpath ${CI_PROJECT_DIR}/..)
    - mv workspace.tar.xz stage-artifacts /tmp
    - rm -rf ${WORKSPACE}
    - mkdir -p ${WORKSPACE}
    - cd ${WORKSPACE}
    - xz -d /tmp/workspace.tar.xz
    - tar -xf /tmp/workspace.tar
    - mv /tmp/stage-artifacts .
  script:
    # Publish boards artifacts and sdimg (when not qemu board).
    - client_version=$($WORKSPACE/integration/extra/release_tool.py --version-of mender --in-integration-version $INTEGRATION_REV)
    - aws s3 cp stage-artifacts/${PUBLISH_BOARD_NAME}_release_1_${client_version}.mender
        s3://mender/${client_version}/${PUBLISH_BOARD_NAME}/${PUBLISH_BOARD_NAME}_release_1_${client_version}.mender
    - aws s3api put-object-acl --acl public-read --bucket mender
        --key ${client_version}/${PUBLISH_BOARD_NAME}/${PUBLISH_BOARD_NAME}_release_1_${client_version}.mender
    - if ! echo $PUBLISH_BOARD_NAME | grep -q qemu; then
    -   aws s3 cp stage-artifacts/mender-${PUBLISH_BOARD_NAME}_${client_version}.sdimg.gz
          s3://mender/${client_version}/${PUBLISH_BOARD_NAME}/mender-${PUBLISH_BOARD_NAME}_${client_version}.sdimg.gz;
    -   aws s3api put-object-acl --acl public-read --bucket mender
          --key ${client_version}/${PUBLISH_BOARD_NAME}/mender-${PUBLISH_BOARD_NAME}_${client_version}.sdimg.gz
    - fi

release:testing-boards:beagleboneblack:manual:
  variables:
    PUBLISH_BOARD_NAME: beagleboneblack
  dependencies:
    - init:workspace
    - build:acceptance:beagleboneblack
  when: manual
  only:
    variables:
      - $BUILD_BEAGLEBONEBLACK == "true"
  extends: .template_release_board_artifacts

release:testing-boards:beagleboneblack:automatic:
  variables:
    PUBLISH_BOARD_NAME: beagleboneblack
  dependencies:
    - init:workspace
    - build:acceptance:beagleboneblack
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true" && $BUILD_BEAGLEBONEBLACK == "true"
  extends: .template_release_board_artifacts

.publish_helper_functions: &publish_helper_functions |
  # Bash function to check if the string is a final tag
  function is_final_tag () {
    local -r version="$1"
    [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
  }
  # Bash function to check if the string is a build tag
  function is_build_tag () {
    local -r version="$1"
    [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+-build[0-9]+$ ]]
  }
  # Bash function to check if the target binary already exists
  function is_published () {
    local -r bucket="$1"
    local -r path="$2"
    aws s3api head-object --bucket "${bucket}" --key "${path}" >/dev/null 2>&1
  }

.template_release_binary_tools:
  tags:
    - mender-qa-worker-generic-light
  # Jobs including this template must set either "dependencies" or "needs"
  # for "init:workspace" and "build:mender-cli".
  stage: release
  image: debian:12
  before_script:
    - *publish_helper_functions
    # Install dependencies
    - apt update && apt install -yyq awscli git wget python3 python3-pip xz-utils
    - wget https://raw.githubusercontent.com/mendersoftware/integration/master/extra/requirements.txt
    - pip install --break-system-packages -r requirements.txt
    # Restore workspace from init stage
    - export WORKSPACE=$(realpath ${CI_PROJECT_DIR}/..)
    - mv workspace.tar.xz stage-artifacts /tmp
    - rm -rf ${WORKSPACE}
    - mkdir -p ${WORKSPACE}
    - cd ${WORKSPACE}
    - xz -d /tmp/workspace.tar.xz
    - tar -xf /tmp/workspace.tar
    - mv /tmp/stage-artifacts .
  script:
    # mender-cli
    - mender_cli_version=$($WORKSPACE/integration/extra/release_tool.py --version-of mender-cli --in-integration-version $INTEGRATION_REV)
    - is_build_or_final_tag=0
    - if is_final_tag "${mender_cli_version}" || is_build_tag "${mender_cli_version}"; then
    -   echo "mender-cli v${mender_cli_version} is final or build tag."
    -   is_build_or_final_tag=1
    - fi
    - echo "=== mender-cli $mender_cli_version ==="
    # We can simplify once mender-cli 1.2.0 is not supported
    - if grep -q build-multiplatform $WORKSPACE/go/src/github.com/mendersoftware/mender-cli/Makefile; then
    -   key="mender-cli/${mender_cli_version}/linux/mender-cli"
    -   if [ $is_build_or_final_tag -eq 1 ] && is_published "mender" "${key}"; then
    -     echo "Not publishing ${key} as it exists and is a final or build tag."
    -   else
    -     echo "Publishing ${mender_cli_version} version for linux to S3"
    -     aws s3 cp stage-artifacts/mender-cli.linux.amd64 "s3://mender/${key}"
    -     aws s3api put-object-acl --acl public-read --bucket mender --key "${key}"
    -   fi

    -   key="mender-cli/${mender_cli_version}/darwin/mender-cli"
    -   if [ $is_build_or_final_tag -eq 1 ] && is_published "mender" "${key}"; then
    -     echo "Not publishing ${key} as it exists and is final or build tag."
    -   else
    -     echo "Publishing ${mender_cli_version} version for darwin to S3"
    -     aws s3 cp stage-artifacts/mender-cli.darwin.amd64 "s3://mender/${key}"
    -     aws s3api put-object-acl --acl public-read --bucket mender --key "${key}"
    -   fi
    - else
    -   key="mender-cli/${mender_cli_version}/mender-cli"
    -   if [ $is_build_or_final_tag -eq 1 ] && is_published "mender" "${key}"; then
    -     echo "Not publishing ${key} as it exists and is final or build tag."
    -   else
    -     aws s3 cp stage-artifacts/mender-cli "s3://mender/${key}"
    -     aws s3api put-object-acl --acl public-read --bucket mender --key "${key}"
    -   fi
    - fi

# Use "needs" for :manual to unlock mender-convert build in advance
# or to trigger it despite mender-qa tests errors
release:mender-cli:manual:
  when: manual
  needs:
    - init:workspace
    - build:mender-cli
  extends: .template_release_binary_tools

release:mender-cli:automatic:
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true"
  dependencies:
    - init:workspace
    - build:mender-cli
  extends: .template_release_binary_tools

.template_release_mender-monitor:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: debian:12
  variables:
    S3_BUCKET_NAME: "mender-binaries"
    S3_BUCKET_PATH: "mender-monitor/yocto"
  dependencies:
    - init:workspace
    - build:mender-monitor:package
  before_script:
    # Install dependencies
    - apt update && apt install -yyq awscli git wget python3 python3-pip xz-utils
    - wget https://raw.githubusercontent.com/mendersoftware/integration/master/extra/requirements.txt
    - pip install --break-system-packages -r requirements.txt
    # Restore workspace from init stage
    - export WORKSPACE=$(realpath ${CI_PROJECT_DIR}/..)
    - mv workspace.tar.xz stage-artifacts /tmp
    - rm -rf ${WORKSPACE}
    - mkdir -p ${WORKSPACE}
    - cd ${WORKSPACE}
    - xz -d /tmp/workspace.tar.xz
    - tar -xf /tmp/workspace.tar
    - mv /tmp/stage-artifacts .
  script:
    - mender_monitor_version=$($WORKSPACE/integration/extra/release_tool.py --version-of monitor-client --in-integration-version $INTEGRATION_REV)
    - echo "=== mender-monitor $mender_monitor_version ==="
    - echo "Publishing $mender_monitor_version version to s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH/$mender_monitor_version/"
    - aws s3 cp stage-artifacts/mender-monitor-*.tar.gz s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH/$mender_monitor_version/

release:mender-monitor:manual:
  when: manual
  extends: .template_release_mender-monitor

release:mender-monitor:automatic:
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true"
  extends: .template_release_mender-monitor

.template_release_mender-gateway:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: debian:12
  variables:
    S3_BUCKET_NAME: "mender-binaries"
    S3_BUCKET_PATH_YOCTO: "mender-gateway/yocto"
    S3_BUCKET_PATH_EXAMPLES: "mender-gateway/examples"
  dependencies:
    - init:workspace
    - build:mender-gateway:package
  before_script:
    # Early exit when building an integration version without mender-gateway
    - apt update && apt install -yyq xz-utils
    - xz -d workspace.tar.xz
    - tar -tf workspace.tar
        ./go/src/github.com/mendersoftware/mender-gateway  >/dev/null 2>/dev/null || exit 0
    # Install dependencies
    - apt update && apt install -yyq awscli git wget python3 python3-pip
    - wget https://raw.githubusercontent.com/mendersoftware/integration/master/extra/requirements.txt
    - pip install --break-system-packages -r requirements.txt
    # Restore workspace from init stage
    - export WORKSPACE=$(realpath ${CI_PROJECT_DIR}/..)
    - mv workspace.tar stage-artifacts /tmp
    - rm -rf ${WORKSPACE}
    - mkdir -p ${WORKSPACE}
    - cd ${WORKSPACE}
    - tar -xf /tmp/workspace.tar
    - mv /tmp/stage-artifacts .
  script:
    - mender_gateway_version=$($WORKSPACE/integration/extra/release_tool.py --version-of mender-gateway --in-integration-version $INTEGRATION_REV)
    - echo "=== mender-gateway $mender_gateway_version ==="
    - echo "Publishing $mender_gateway_version version to s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH_YOCTO/$mender_gateway_version/"
    - aws s3 cp stage-artifacts/mender-gateway-*.tar.xz s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH_YOCTO/$mender_gateway_version/
    - aws s3 cp stage-artifacts/mender-gateway-examples-*.tar s3://$S3_BUCKET_NAME/$S3_BUCKET_PATH_EXAMPLES/$mender_gateway_version/

release:mender-gateway:manual:
  when: manual
  extends: .template_release_mender-gateway

release:mender-gateway:automatic:
  only:
    variables:
      - $PUBLISH_RELEASE_AUTOMATIC == "true"
  extends: .template_release_mender-gateway

.template_release_docker_images:client-only:
  tags:
    - mender-qa-worker-generic-light
  stage: release
  image: docker
  services:
    - docker:dind
  dependencies:
    - init:workspace
    - build:client:qemu
    - build:client:docker
  before_script:
    # Check correct dind setup
    - docker version
    # Install dependencies
    - apk --update add git python3 py3-pip xz
    - wget https://raw.githubusercontent.com/mendersoftware/integration/master/extra/requirements.txt
    - pip3 install --break-system-packages -r requirements.txt
    # Restore workspace from init stage
    - export WORKSPACE=$(realpath ${CI_PROJECT_DIR}/..)
    - mv workspace.tar.xz /tmp
    - rm -rf ${WORKSPACE}
    - mkdir -p ${WORKSPACE}
    - cd ${WORKSPACE}
    - xz -d /tmp/workspace.tar.xz
    - tar -xf /tmp/workspace.tar
    # Login for private repos
    - docker login -u menderbuildsystem -p ${DOCKER_HUB_PASSWORD}
    - docker login -u ntadm_menderci -p ${REGISTRY_MENDER_IO_PASSWORD} registry.mender.io
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    # Load, tag and push mender-client-* images
    - for image in $($WORKSPACE/integration/extra/release_tool.py --list docker | egrep 'mender-client|mender-qemu|mender-monitor|mender-gateway-qemu-commercial'); do
    #   Historical note,
    #   The version here used to be determined by the release_tool, which could distinguish between
    #   git repo version and container image version. Today this is kind of messy, as we moved out
    #   the backend to a separate repo but we haven't done deep changes in the release process for
    #   the rest, and "--version-of" option gives bogus results.
    #   TLDR; hardcode to mender-${INTEGRATION_REV} version for the Virtual Devices images
    -   version=mender-${INTEGRATION_REV}
    -   docker_url=$($WORKSPACE/integration/extra/release_tool.py --map-name docker $image docker_url)
    -   docker pull ${GITLAB_REGISTRY_PREFIX}-${image}
    -   docker tag ${GITLAB_REGISTRY_PREFIX}-${image} ${docker_url}:${version}
    -   docker push $docker_url:${version}
    - done

# This job allows mender repo to publish the related Docker client images on
# merges to master or release branches.
release:virtual-client:manual:
  when: manual
  extends: .template_release_docker_images:client-only

# This job allows a release to publish only the client images. Specifically designed for Mender 3.7
# series, to complement job release_docker_multiplatform_images:manual
release:virtual-client:automatic:
  only:
    variables:
      - $PUBLISH_DOCKER_CLIENT_IMAGES == "true"
  extends: .template_release_docker_images:client-only
